<html>
<head>
  <meta charset="UTF-8">
  <script src="links_01_aaa.json.js"></script>
  <script src="links_02_bbb.json.js"></script>
  <script src="links_03_ccc.json.js"></script>
  <script src="links_99_zzz.json.js"></script>
</head>
<body>
<input type="button" value="links_01" onclick='root_flow("list01");' />
<input type="button" value="links_02" onclick='root_flow("list02");' />
<input type="button" value="links_03" onclick='root_flow("list03");' />
<input type="button" value="links_99" onclick='root_flow("list99");' />
<HR>

<BR />
<label for="number_of_blank_cells">新規登録枠数</label>
<input type="text" id="number_of_blank_cells" name="number_of_blank_cells" value="3">

<div id="form_area">※既存のjson.jsファイルを読み込みフォーム形式で表示※</div>
<div id="savebutton_area">※保存ボタンを表示※</div>
<div id="message_area">※警告メッセージなどを表示※</div>
<textarea id="json_area" cols="80" rows="10">※新規のjson.js情報※</textarea>

<script>

// ストレージの定義
const storage = localStorage;

// 項目-群
const item_jsn = [
  {"item": "aicon", "line_flg": 0},
  {"item": "kana", "line_flg": 0},
  {"item": "Name", "line_flg": 0},
  {"item": "URL", "line_flg": 0},
  {"item": "category", "line_flg": 1},
  {"item": "note", "line_flg": 1},
];

// json.js の info 情報
info_out = "";
// formタグの情報を格納
wstr = ""

// 更新対象のjson.jsファイル
list_no = "";
list_str = "";  // list 情報
info_str = "";  // info 情報

js_file_name = new Array();
js_file_name["list01"] = "links_01_aaa.json.js";
js_file_name["list02"] = "links_02_bbb.json.js";
js_file_name["list03"] = "links_03_ccc.json.js";
js_file_name["list99"] = "links_99_zzz.json.js";

// 更新対象のjson.js変数
list_target = "";
info_target = "";


function set_form_cell(form_flg, line_flg, elemnet, item_val){
  // 1項目の入力フォームを作る
  lo_str = "";
  lo_str+= '<div>';
  lo_str+= '<label for="'+elemnet+'">'+elemnet+'</label>';
  if(line_flg == 0){
    lo_str+= '<input type="text" id="'+elemnet+'" name="'+elemnet+'" value="'+ item_val +'">';
  }else{
    lo_str+= '<textarea id="'+elemnet+'" name="'+elemnet+'" cols="30" rows="3">'+ item_val +'</textarea>';
  }
  lo_str+= '</div>';
  return(lo_str);
}

function set_form_flow(item_jsn, list_elem){
  // 指定データをもとにフォームを作る。指定データがなければ値は空になる
  let wstr_lo = "";
  let item_val = "";
  let tmp_val = "";
  for (const elem in item_jsn) {
    form_flg = 1;
    line_flg = Number(item_jsn[elem]["line_flg"]);
    item_name = item_jsn[elem]["item"];

    item_no = Number(elem) + 1;
    if(elem == 0){
      form_flg = 0;
    }else if(item_no == item_jsn.length){
      form_flg = -1;
    }

    item_val = list_elem[item_name];

    if (typeof item_val === "undefined"){
      item_val = "";
    }else  if (typeof item_val === "object"){
      tmp_val = "";
      for(const cell in item_val){
        if (item_val[cell]["key"] != ""){
          tmp_val += '"'+item_val[cell]["key"]+'": "'+item_val[cell]["kana"] + '"\n';
        }
      }
      tmp_val = tmp_val.trim();  // 最後の改行コードを削除
      item_val = tmp_val;
    }
    wstr_lo += set_form_cell(form_flg, line_flg, item_name, item_val);
  }
  return(wstr_lo);
}


function make_data_to_jsformat(){
  wstr_out = "";
  //info_out = "";
  list_out = "";
  current_out = "";
  write_flg = 1;
  name_out = "";
  value_out= "";
  warning_msg = "";  // category欄に undefined があった場合に警告を出す
  warning_msg_cell = "";

  // フォームの情報を取得
  const form_elements = document.forms.linklist;

  for(index = 0; index < form_elements.length; index++){
    name_out = form_elements.elements.item(index).name;
    value_out= form_elements.elements.item(index).value;

    switch (name_out){
      case "aicon":
        current_out += "{\n";
        if(value_out != ""){
          current_out +=  '\t"'+ name_out +'": "'+ value_out +'",\n';
        }
        break;
      case "kana":
        current_out +=  '\t"'+ name_out +'": "'+ value_out +'",\n';
        break;
      case "Name":
        current_out +=  '\t"'+ name_out +'": "'+ value_out +'",\n';
        if(value_out == "") write_flg = 0;
        break;
      case "URL":
        current_out +=  '\t"'+ name_out +'": "'+ value_out +'",\n';
        break;
      case "category":
        tmp_out = set_category_out(value_out);

        if(tmp_out.indexOf('undefined') > 0){
          warning_msg_cell += "category欄に undefined が含まれています [" + tmp_out + "]<BR />";
        }

        current_out += '\t"'+ name_out +'":\n';
        current_out += '\t\t[\n';
        current_out += '\t\t\t' + tmp_out + '\n';
        current_out += '\t\t],\n';
        break;
      case "note":
        value_out = value_out.replace(/\n/g, '\\n')
        current_out +=  '\t"'+ name_out +'": "'+ value_out +'"\n';
        current_out += "},";
        if(write_flg == 1){
          // 新json.jsファイルに追記する情報
          list_out += current_out;
          warning_msg += warning_msg_cell;
        }
        current_out = "";
        write_flg = 1;
        warning_msg_cell = "";
        break;
    }
  }
  list_out = '"list": [\n' + list_out + "\n]";
  wstr_out += "let " + list_no + " = {\n";
  wstr_out += info_out + ",\n";
  wstr_out += list_out;
  wstr_out += "};";

  document.getElementById("json_area").innerHTML = wstr_out;
  document.getElementById("message_area").innerHTML = '<font color="red">' + warning_msg + "</font>";

  let text = document.getElementById("json_area");
  text.select();
  document.execCommand("copy");
  document.getElementById("savebutton_area").innerHTML = "<input type='button' value='ファイル出力' onclick='outputText();' />";
}


function set_category_out(value_out){
  out_lo = "";
  out_arr = new Array();
  tmp_arr = new Array();
  tmp_key = "";
  tmp_kana= "";
  tmp_head_1 = "";
  tmp_head_2 = "";
  out_arr = value_out.split("\n")

  for(const line in out_arr){
    tmp_arr.length = 0;
    tmp_arr = out_arr[line].split('"');
    tmp_key = tmp_arr[1];
    tmp_kana= tmp_arr[3];
    if (typeof tmp_kana !== "undefined"){
      tmp_head_1 = tmp_kana[0];  // 1文字目を取得
      tmp_head_2 = tmp_head_1.normalize('NFD')[0];  // 濁音→静音に変換
      tmp_kana = tmp_kana.replace(tmp_head_1, tmp_head_2);
    }
    out_lo += '\t\t\t{ "key": "' + tmp_key + '", "kana": "' + tmp_kana +'"},\n';
  }
  out_lo = out_lo.trim();  // 最後の改行コードを削除
  out_lo = out_lo.slice(0, -1);  // 最後の文字 ,(コロン)を削除
  return(out_lo);
}


function set_init(){
  document.getElementById("form_area").innerHTML = "";
  document.getElementById("message_area").innerHTML = "";
  document.getElementById("json_area").innerHTML = "";
  wstr = "";
  list_str = "";
  info_str = "";
  info_out = "";
  document.getElementById("savebutton_area").innerHTML = "";  // ファイル出力ボタンを消す
}


function set_links_no(arg_no){
  // 使ってない
  list_str_lo = "";
  info_str_lo = "";
  switch (arg_no){
      case "list01": 
        list_str_lo = 'list01["list"]';
        info_str_lo = 'list01["info"]';
        break;
      case "list02":
        list_str_lo = 'list02["list"]';
        info_str_lo = 'list02["info"]';
        break;
      case "list03":
        list_str_lo = 'list03["list"]';
        info_str_lo = 'list03["info"]';
        break;
      case "list99":
        list_str_lo = 'list99["list"]';
        info_str_lo = 'list99["info"]';
        break;
  }
}

function root_flow(arg_no){
  set_init();  // 初期値設定
  list_no = arg_no;
  wstr += '<form name="linklist" action="" onsubmit="">'

  //list_str = 'list01["list"]';
  //info_str = 'list01["info"]';

  switch (arg_no){
      case "list01": list_str = 'list01["list"]'; info_str = 'list01["info"]'; break;
      case "list02": list_str = 'list02["list"]'; info_str = 'list02["info"]'; break;
      case "list03": list_str = 'list03["list"]'; info_str = 'list03["info"]'; break;
      case "list99": list_str = 'list99["list"]'; info_str = 'list99["info"]'; break;
  }

  list_target = eval(list_str);
  info_target = eval(info_str)

  info_out += '"info": {"Title":"' + info_target["Title"] + '","ID":"' + info_target["ID"] + '"}';

  for (const elem in list_target) {
    // jsonデータを設定値にしてフォームを作る
    wstr += set_form_flow(item_jsn,list_target[elem]);
    wstr += "<HR />";
  }

  // 新規登録用のフォーム枠を作る数を取得する
  const LPMAX = Number(document.getElementById("number_of_blank_cells").value);
  
  for(let step = 0; step < LPMAX; step++) {
    // 各値が空白のフォームを作る
    wstr += set_form_flow(item_jsn, "NONE");
    wstr += "<HR />";
  }

  wstr += '</form>';
  wstr += '<input type="button" value="jsファイル作成" onclick="make_data_to_jsformat();" />';

  document.getElementById("form_area").innerHTML = wstr;
}

function outputText(){
  // 作成したリンク集をファイル出力する
  let str = "";
  str += document.getElementById("json_area").innerHTML;
  let ary = str.split(''); // 配列形式に変換（後述のBlobで全要素出力）
  let blob = new Blob(ary,{type:"text/plan"}); // テキスト形式でBlob定義
  let link = document.createElement('a'); // HTMLのaタグを作成
  link.href = URL.createObjectURL(blob); // aタグのhref属性を作成
  link.download = js_file_name[list_no]; // aタグのdownload属性を作成
  link.click(); // 定義したaタグをクリック（実行）
}

// ----------------------------------- //
// ROOT FLOW

set_init();  // 初期値設定

</script>
</body>
</html>
